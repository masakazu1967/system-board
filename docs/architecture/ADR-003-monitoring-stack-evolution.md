# ADR-003: 監視スタックの進化 - Sentryからセルフホステッド、そしてGrafana Lokiへ

**ステータス**: 採用
**決定日**: 2025年9月13日（最終決定）
**決定者**: DevOpsエンジニア、ソフトウェアアーキテクト、サイバーセキュリティアドバイザー

## コンテキスト

System Boardプロジェクトの監視スタックは、以下の3段階の検討を経て最終的な採用技術が決定されました：

### 第1段階: 初期監視スタック（2025年9月11日）

- **Prometheus + Grafana**: メトリクス監視
- **ELK Stack**: ログ管理
- **Microsoft Teams**: アラート・エスカレーション

### 第2段階: Sentry導入検討（2025年9月12日）

運用効率化を目的として、フルマネージドサービスであるSentryの導入が検討されました。

### 第3段階: セルフホステッド強化検討（2025年9月12日）

セキュリティ要件によりSentry見送り後、GlitchTip等の自己ホスティング監視スタックが検討されました。

### 第4段階: Grafana Loki採用決定（2025年9月13日）

パブリッククラウド採用とともに、Grafana Lokiを中心とした統合監視スタックの採用が決定されました。

## 検討した選択肢と決定の変遷

### 段階1: Sentry マネージドサービス検討

#### メリット評価

- **運用負荷削減**: 50-70%のメンテナンス工数削減見込み
- **開発者体験**: コンテキスト付きデバッグによる改善
- **無料枠対応**: 5,000エラー/月、10,000パフォーマンス単位/月で対応可能

#### セキュリティ評価結果: **MEDIUM-HIGH リスク**

- **第三者データ管理**: 全エラーデータがSentryインフラに保存
- **国境越えデータ転送**: データローカライゼーション要件違反リスク
- **製造業機密情報漏洩**: 生産パラメータ、プロセスデータの露出リスク

#### 決定: **見送り**

製造業環境のセキュリティ要件と情報漏洩防止の優先方針により、Sentryマネージドサービスの導入は適切でないと判断。

### 段階2: セルフホステッド監視スタック検討

#### 提案されたスタック

```yaml
monitoring_stack:
  error_tracking:
    - GlitchTip (オープンソースSentry代替)
    - ELK Stackによるカスタムエラー集約の強化

  performance_monitoring:
    - Jaeger (分散トレーシング)
    - OpenTelemetry (ベンダー中立な可観測性)
    - Grafanaダッシュボード拡張

  alerting:
    - AlertManager (Prometheusエコシステム)
    - Microsoft Teams統合（既定通り）
```

#### 評価結果

- **セキュリティ**: MEDIUM-HIGH → LOW-MEDIUM（大幅改善）
- **運用複雑性**: MEDIUM-HIGH（管理可能）
- **実装工数**: 40-60時間（初期）、4-6時間/週（継続）

#### 決定: **技術的に有効だが、より統合的なソリューションを検討**

### 段階3: Grafana Loki採用決定

#### 決定理由

1. **パブリッククラウド戦略との整合性**: クラウドネイティブな監視ソリューション
2. **Prometheusエコシステムとの統合**: 既存のGrafana/Prometheusとの自然な統合
3. **運用工数削減**: ELKスタックからの40%削減効果
4. **GlitchTip機能の70%代替**: 基本的なエラートラッキング要件を満たす

## 最終決定内容

**Grafana Lokiを中心とした統合監視スタックの採用**:

### 最終監視アーキテクチャ

```yaml
final_monitoring_stack:
  log_management:
    - Grafana Loki (ログ収集・クエリ)
    - Promtail (ログ配送)

  metrics_monitoring:
    - Prometheus (メトリクス収集)
    - Grafana (可視化・ダッシュボード)

  alerting:
    - AlertManager (アラート管理)
    - Microsoft Teams (通知統合)

  error_tracking:
    - 構造化エラーログ via Loki
    - 必要時GlitchTip追加検討
```

### 代替可能な機能（70%）

- 基本的なエラーログ収集・表示
- エラー頻度の可視化
- 基本的なアラート機能

### 代替困難な機能（30%）

- エラーの自動グルーピング（手動実装が必要）
- スタックトレース解析（構造化が複雑）
- リアルタイムエラー通知（設定が煩雑）
- パフォーマンス監視（APM機能）

## 実装戦略

### Phase 1: Grafana Loki基盤構築（2週間）

- [ ] Grafana Loki環境構築
- [ ] 構造化エラーログ機能の設計・実装
- [ ] 基本的なログクエリとダッシュボード構築

### Phase 2: 統合監視システム構築（4週間）

- [ ] Prometheus/Grafana統合
- [ ] Microsoft Teams通知機能実装
- [ ] アラートルールとエスカレーション設定

### Phase 3: 高度な監視機能実装（4週間）

- [ ] 構造化エラートラッキングの強化
- [ ] パフォーマンス監視機能追加
- [ ] 必要に応じてGlitchTip追加検討

## セキュリティ要件対応

### データローカライゼーション

- **完全な自己管理**: 全ログデータの企業内管理
- **データ暗号化**: 保存時・転送時の暗号化実装
- **アクセス制御**: RBAC + MFA による厳格なアクセス管理

### 監査・コンプライアンス

- **5年間ログ保持**: 製造業監査要件への対応
- **改ざん防止**: 改ざん検知機能の実装
- **監査ログ**: 全アクセス・変更の記録

## 期待される成果

### 運用効率化

- **ELKスタック運用工数**: 40%削減
- **統合ダッシュボード**: 監視作業の一元化
- **アラート統合**: Microsoft Teamsでの統一通知

### セキュリティ強化

- **データ主権確保**: 完全な企業管理下での運用
- **セキュリティリスク**: Sentryの MEDIUM-HIGH から LOW への改善
- **コンプライアンス**: 製造業標準への完全対応

### 将来拡張性

- **段階的強化**: 需要に応じたGlitchTip等の追加
- **クラウドネイティブ**: パブリッククラウドでの最適運用
- **スケーラビリティ**: ログ量増加に対応した階層化ストレージ

## リスク管理

### 技術リスク

- **機能不足**: 70%機能代替での運用開始
- **学習コスト**: Grafana Loki習得に必要な時間投資
- **運用複雑性**: 複数コンポーネントの統合管理

### 緩和策

- **段階的実装**: MVP優先での段階的機能追加
- **フォールバック**: 必要時の追加ツール導入準備
- **ドキュメント整備**: 運用手順書の充実

## 影響

### ポジティブな影響

- **セキュリティ**: 情報漏洩リスクの大幅軽減
- **運用効率**: ELKスタック運用工数の削減
- **統合性**: Prometheusエコシステムとの一貫性
- **コスト**: オープンソースツールによる費用抑制

### 課題

- **機能ギャップ**: 一部のエラートラッキング機能の手動実装
- **初期セットアップ**: 統合環境構築の複雑性
- **運用習熟**: 新しいツールチェーンの学習

## 関連するADR

- ADR-001: オニオンアーキテクチャ採用
- ADR-002: パブリッククラウド採用戦略
- ADR-004: Event Sourcing実装アプローチ

## 参照

- Sentry導入検討会議議事録 (2025-09-12)
- 自己ホスティング監視スタック技術検討会議議事録 (2025-09-12)
- アーキテクチャ変更会議議事録 (2025-09-13)
- 例外処理・エラーハンドリング設計ドキュメント
