# ADR-001: ヘキサゴナルアーキテクチャからオニオンアーキテクチャへの変更

**ステータス**: 採用
**決定日**: 2025年9月13日
**決定者**: ソフトウェアアーキテクト、バックエンドシステムアーキテクト、DevOpsエンジニア、セキュリティエンジニア、データベースアーキテクト

## コンテキスト

System Boardプロジェクト開始時（2025年9月11日）には、ヘキサゴナルアーキテクチャ（ポート・アダプターパターン）の採用が決定されていました。しかし、以下の理由から、アーキテクチャパターンの見直しが必要となりました：

1. **ドメイン駆動設計（DDD）の実装要件**: Event Sourcing + CQRSとDDDの組み合わせにおいて、ドメイン層とアプリケーション層の明確な分離が必要
2. **長期保守性の向上**: 複雑なビジネスロジックの管理において、より構造化されたアプローチが必要
3. **テスタビリティの向上**: 依存関係の逆転とレイヤー分離の明確化
4. **Event Sourcing/CQRSとの親和性**: イベントドリブンアーキテクチャとの整合性

## 検討した選択肢

### 選択肢1: ヘキサゴナルアーキテクチャの維持

- **メリット**:
  - 既に設計済み、変更コストが低い
  - ポート・アダプターパターンでの外部システム連携が明確
- **デメリット**:
  - ドメイン層内での詳細な構造化が困難
  - 複雑なビジネスルールの管理が曖昧
  - Event Sourcingでのアグリゲート設計との整合性に課題

### 選択肢2: オニオンアーキテクチャの採用

- **メリット**:
  - ドメイン層とアプリケーション層の明確な分離
  - DDD実装における境界づけコンテキストとの整合性
  - Event Sourcing/CQRSとの高い親和性
  - 長期保守性とテスタビリティの大幅向上
- **デメリット**:
  - 設計変更に伴う追加工数（約3ヶ月）
  - 開発チームの学習コスト

### 選択肢3: クリーンアーキテクチャの採用

- **メリット**:
  - 依存関係の逆転による高い柔軟性
  - フレームワーク非依存の設計
- **デメリット**:
  - 過度に抽象的な設計となるリスク
  - NestJSとの統合の複雑性

## 決定内容

**オニオンアーキテクチャを採用**:

以下の理由により、オニオンアーキテクチャの採用を決定しました：

1. **DDD実装における明確なレイヤー分離の実現**
2. **Event Sourcing/CQRSとの高い親和性**
3. **長期保守性とテスタビリティの大幅向上**
4. **NestJSでの実装可能性の確認**

## 実装戦略

### Phase 1: モジュラーモノリス構築（4週間）

```typescript
// Domain層: Pure TypeScript classes (NestJS decorators不要)
// Application層: NestJSサービス with Dependency Injection
// Infrastructure層: NestJSプロバイダー with Repository pattern
```

### Phase 2: 段階的マイクロサービス展開

- System Management Service: システム・パッケージ管理
- Task Management Service: タスク・ワークフロー管理
- Vulnerability Service: 脆弱性・評価管理
- Relationship Service: 依存関係管理

### レイヤー構成

```text
Presentation Layer (UI/API)
    ↓
Application Layer (Use Cases/Services)
    ↓
Domain Layer (Business Logic/Aggregates)
    ↓
Infrastructure Layer (Database/External APIs)
```

## 影響

### ポジティブな影響

- **DDD実装の品質向上**: ドメインロジックの純粋性確保
- **テストの容易性**: 各レイヤーの独立したテスト
- **Event Sourcingとの整合性**: アグリゲート設計の明確化
- **長期保守性**: ビジネスロジックの変更容易性

### 課題とリスク

- **実装期間の延長**: 13週間（約3ヶ月）の段階的実装
- **学習コスト**: チームでのオニオンアーキテクチャ習得
- **複雑性の管理**: 適切なレイヤー境界の維持

## 関連するADR

- ADR-002: マイクロサービス化戦略
- ADR-003: Event Sourcing実装アプローチ
- ADR-004: 監視スタック変更決定

## 参照

- プロジェクト憲章共有会議議事録 (2025-09-11)
- アーキテクチャ変更会議議事録 (2025-09-13)
- Event Sourcing設計ドキュメント
