# データベーススキーマ設計

**担当**: データベースアーキテクト
**作成日**: 2025-09-20
**Issue**: #121
**見積**: 30分
**親Issue**: #34 US-SM-001: システム新規登録

## 1. PostgreSQL ReadModel テーブル設計

### 1.1 systems テーブル

システム情報を格納するメインテーブル

```sql
CREATE TABLE systems (
    -- Primary Identity
    system_id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    type VARCHAR(20) NOT NULL CHECK (type IN ('WEB', 'API', 'DATABASE', 'BATCH', 'OTHER')),
    status VARCHAR(20) NOT NULL CHECK (status IN ('PLANNING', 'ACTIVE', 'MAINTENANCE', 'DECOMMISSIONED', 'CANCELLED')),

    -- Host Configuration
    host_cpu_cores INTEGER NOT NULL,
    host_memory_gb INTEGER NOT NULL,
    host_storage_gb INTEGER NOT NULL,
    host_os VARCHAR(100),
    host_os_version VARCHAR(50),
    host_encryption_enabled BOOLEAN NOT NULL DEFAULT false,

    -- Security & Compliance
    security_classification VARCHAR(20) NOT NULL CHECK (security_classification IN ('PUBLIC', 'INTERNAL', 'CONFIDENTIAL', 'RESTRICTED')),
    criticality_level VARCHAR(10) NOT NULL CHECK (criticality_level IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')),

    -- Lifecycle Management
    created_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_modified TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    decommission_date TIMESTAMP WITH TIME ZONE,

    -- Metadata
    version INTEGER NOT NULL DEFAULT 1,
    created_by VARCHAR(255),
    last_modified_by VARCHAR(255),

    -- Constraints
    UNIQUE(name),
    CHECK (decommission_date IS NULL OR decommission_date > created_date),
    CHECK (last_modified >= created_date)
);
```

### 1.2 system_types テーブル

システム種別の参照マスタテーブル

```sql
CREATE TABLE system_types (
    type_code VARCHAR(20) PRIMARY KEY,
    type_name VARCHAR(100) NOT NULL,
    description TEXT,
    default_criticality VARCHAR(10) NOT NULL CHECK (default_criticality IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')),
    requires_encryption BOOLEAN NOT NULL DEFAULT false,
    min_cpu_cores INTEGER NOT NULL DEFAULT 1,
    min_memory_gb INTEGER NOT NULL DEFAULT 1,
    min_storage_gb INTEGER NOT NULL DEFAULT 10,
    created_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN NOT NULL DEFAULT true
);

-- 初期データ投入
INSERT INTO system_types (type_code, type_name, description, default_criticality, requires_encryption, min_cpu_cores, min_memory_gb, min_storage_gb) VALUES
('WEB', 'Webアプリケーション', 'ユーザー向けWebアプリケーションシステム', 'MEDIUM', false, 2, 4, 20),
('API', 'APIサーバー', 'REST/GraphQL APIを提供するシステム', 'HIGH', true, 2, 8, 50),
('DATABASE', 'データベース', 'データベース管理システム', 'CRITICAL', true, 4, 16, 100),
('BATCH', 'バッチ処理', 'バックグラウンドバッチ処理システム', 'MEDIUM', false, 1, 2, 10),
('OTHER', 'その他', 'その他のシステム', 'LOW', false, 1, 1, 10);
```

### 1.3 system_packages テーブル

システムにインストールされているパッケージ情報

```sql
CREATE TABLE system_packages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    system_id UUID NOT NULL REFERENCES systems(system_id) ON DELETE CASCADE,
    package_name VARCHAR(255) NOT NULL,
    package_version VARCHAR(100) NOT NULL,
    package_type VARCHAR(50) NOT NULL, -- npm, pip, apt, yum, etc.
    install_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_updated TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    is_security_compliant BOOLEAN NOT NULL DEFAULT true,
    license_type VARCHAR(100),

    -- Composite unique constraint
    UNIQUE(system_id, package_name, package_type),

    -- Indexes for performance
    INDEX idx_system_packages_system_id (system_id),
    INDEX idx_system_packages_name_type (package_name, package_type),
    INDEX idx_system_packages_security (is_security_compliant)
);
```

### 1.4 system_name_reservations テーブル

システム名の同時登録防止用テーブル

```sql
CREATE TABLE system_name_reservations (
    name VARCHAR(255) PRIMARY KEY,
    reserved_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    reserved_by VARCHAR(255),

    CHECK (expires_at > reserved_at)
);

-- 期限切れレコードの自動削除用インデックス
CREATE INDEX idx_system_name_reservations_expires_at ON system_name_reservations(expires_at);
```

### 1.5 Read Model View

システム情報の読み取り最適化ビュー

```sql
CREATE VIEW system_summary_view AS
SELECT
    s.system_id,
    s.name,
    s.type,
    s.status,
    s.security_classification,
    s.criticality_level,
    s.created_date,
    s.last_modified,
    s.decommission_date,
    st.type_name,
    st.description as type_description,
    COUNT(sp.id) as package_count,
    COUNT(CASE WHEN sp.is_security_compliant = false THEN 1 END) as non_compliant_packages
FROM systems s
LEFT JOIN system_types st ON s.type = st.type_code
LEFT JOIN system_packages sp ON s.system_id = sp.system_id
GROUP BY s.system_id, s.name, s.type, s.status, s.security_classification, s.criticality_level,
         s.created_date, s.last_modified, s.decommission_date, st.type_name, st.description;
```

## 2. EventStore DB イベントスキーマ設計

### 2.1 System ストリーム設計

**ストリーム命名規則**: `system-{systemId}`

### 2.2 SystemRegistered イベントスキーマ

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "title": "SystemRegistered",
  "version": "1.0",
  "properties": {
    "eventId": {
      "type": "string",
      "format": "uuid",
      "description": "一意のイベントID"
    },
    "eventType": {
      "type": "string",
      "const": "SystemRegistered",
      "description": "イベント種別"
    },
    "eventVersion": {
      "type": "string",
      "const": "1.0",
      "description": "イベントスキーマバージョン"
    },
    "occurredAt": {
      "type": "string",
      "format": "date-time",
      "description": "イベント発生日時"
    },
    "aggregateId": {
      "type": "string",
      "format": "uuid",
      "description": "システムID"
    },
    "aggregateVersion": {
      "type": "integer",
      "minimum": 1,
      "description": "集約バージョン"
    },
    "data": {
      "type": "object",
      "properties": {
        "systemId": {
          "type": "string",
          "format": "uuid",
          "description": "システムID"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 255,
          "description": "システム名"
        },
        "type": {
          "type": "string",
          "enum": ["WEB", "API", "DATABASE", "BATCH", "OTHER"],
          "description": "システム種別"
        },
        "hostConfiguration": {
          "type": "object",
          "properties": {
            "cpuCores": {
              "type": "integer",
              "minimum": 1,
              "description": "CPUコア数"
            },
            "memoryGb": {
              "type": "integer",
              "minimum": 1,
              "description": "メモリ容量(GB)"
            },
            "storageGb": {
              "type": "integer",
              "minimum": 1,
              "description": "ストレージ容量(GB)"
            },
            "operatingSystem": {
              "type": "string",
              "description": "OS名"
            },
            "osVersion": {
              "type": "string",
              "description": "OSバージョン"
            },
            "encryptionEnabled": {
              "type": "boolean",
              "description": "暗号化有効フラグ"
            }
          },
          "required": ["cpuCores", "memoryGb", "storageGb", "encryptionEnabled"]
        },
        "securityClassification": {
          "type": "string",
          "enum": ["PUBLIC", "INTERNAL", "CONFIDENTIAL", "RESTRICTED"],
          "description": "セキュリティ分類"
        },
        "criticalityLevel": {
          "type": "string",
          "enum": ["LOW", "MEDIUM", "HIGH", "CRITICAL"],
          "description": "クリティカルレベル"
        },
        "initialPackages": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string",
                "description": "パッケージ名"
              },
              "version": {
                "type": "string",
                "description": "パッケージバージョン"
              },
              "type": {
                "type": "string",
                "description": "パッケージ種別"
              },
              "isSecurityCompliant": {
                "type": "boolean",
                "description": "セキュリティ準拠フラグ"
              },
              "licenseType": {
                "type": "string",
                "description": "ライセンス種別"
              }
            },
            "required": ["name", "version", "type", "isSecurityCompliant"]
          },
          "description": "初期インストールパッケージ"
        },
        "registeredAt": {
          "type": "string",
          "format": "date-time",
          "description": "登録日時"
        },
        "registeredBy": {
          "type": "string",
          "description": "登録者"
        }
      },
      "required": [
        "systemId",
        "name",
        "type",
        "hostConfiguration",
        "securityClassification",
        "criticalityLevel",
        "initialPackages",
        "registeredAt"
      ]
    },
    "metadata": {
      "type": "object",
      "properties": {
        "correlationId": {
          "type": "string",
          "format": "uuid",
          "description": "相関ID"
        },
        "causationId": {
          "type": "string",
          "format": "uuid",
          "description": "因果ID"
        },
        "userId": {
          "type": "string",
          "description": "実行ユーザーID"
        },
        "source": {
          "type": "string",
          "description": "イベント発生源"
        }
      }
    }
  },
  "required": [
    "eventId",
    "eventType",
    "eventVersion",
    "occurredAt",
    "aggregateId",
    "aggregateVersion",
    "data"
  ]
}
```

### 2.3 SystemConfigurationUpdated イベントスキーマ

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "title": "SystemConfigurationUpdated",
  "version": "1.0",
  "properties": {
    "eventId": {
      "type": "string",
      "format": "uuid"
    },
    "eventType": {
      "type": "string",
      "const": "SystemConfigurationUpdated"
    },
    "eventVersion": {
      "type": "string",
      "const": "1.0"
    },
    "occurredAt": {
      "type": "string",
      "format": "date-time"
    },
    "aggregateId": {
      "type": "string",
      "format": "uuid"
    },
    "aggregateVersion": {
      "type": "integer",
      "minimum": 2
    },
    "data": {
      "type": "object",
      "properties": {
        "systemId": {
          "type": "string",
          "format": "uuid"
        },
        "previousConfiguration": {
          "type": "object",
          "description": "変更前の構成情報"
        },
        "newConfiguration": {
          "type": "object",
          "description": "変更後の構成情報"
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        },
        "updatedBy": {
          "type": "string"
        },
        "changeReason": {
          "type": "string",
          "description": "変更理由"
        }
      },
      "required": ["systemId", "newConfiguration", "updatedAt"]
    }
  },
  "required": [
    "eventId",
    "eventType",
    "eventVersion",
    "occurredAt",
    "aggregateId",
    "aggregateVersion",
    "data"
  ]
}
```

### 2.4 PackageInstalled イベントスキーマ

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "title": "PackageInstalled",
  "version": "1.0",
  "properties": {
    "eventId": {
      "type": "string",
      "format": "uuid"
    },
    "eventType": {
      "type": "string",
      "const": "PackageInstalled"
    },
    "eventVersion": {
      "type": "string",
      "const": "1.0"
    },
    "occurredAt": {
      "type": "string",
      "format": "date-time"
    },
    "aggregateId": {
      "type": "string",
      "format": "uuid"
    },
    "aggregateVersion": {
      "type": "integer",
      "minimum": 1
    },
    "data": {
      "type": "object",
      "properties": {
        "systemId": {
          "type": "string",
          "format": "uuid"
        },
        "package": {
          "type": "object",
          "properties": {
            "name": {
              "type": "string"
            },
            "version": {
              "type": "string"
            },
            "type": {
              "type": "string"
            },
            "isSecurityCompliant": {
              "type": "boolean"
            },
            "licenseType": {
              "type": "string"
            }
          },
          "required": ["name", "version", "type", "isSecurityCompliant"]
        },
        "installedAt": {
          "type": "string",
          "format": "date-time"
        },
        "installedBy": {
          "type": "string"
        }
      },
      "required": ["systemId", "package", "installedAt"]
    }
  },
  "required": [
    "eventId",
    "eventType",
    "eventVersion",
    "occurredAt",
    "aggregateId",
    "aggregateVersion",
    "data"
  ]
}
```

### 2.5 SystemDecommissioned イベントスキーマ

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "title": "SystemDecommissioned",
  "version": "1.0",
  "properties": {
    "eventId": {
      "type": "string",
      "format": "uuid"
    },
    "eventType": {
      "type": "string",
      "const": "SystemDecommissioned"
    },
    "eventVersion": {
      "type": "string",
      "const": "1.0"
    },
    "occurredAt": {
      "type": "string",
      "format": "date-time"
    },
    "aggregateId": {
      "type": "string",
      "format": "uuid"
    },
    "aggregateVersion": {
      "type": "integer",
      "minimum": 1
    },
    "data": {
      "type": "object",
      "properties": {
        "systemId": {
          "type": "string",
          "format": "uuid"
        },
        "decommissionReason": {
          "type": "string",
          "description": "廃止理由"
        },
        "dataRetentionPeriod": {
          "type": "integer",
          "minimum": 0,
          "description": "データ保持期間(日)"
        },
        "decommissionedAt": {
          "type": "string",
          "format": "date-time"
        },
        "decommissionedBy": {
          "type": "string"
        },
        "finalBackupLocation": {
          "type": "string",
          "description": "最終バックアップ場所"
        }
      },
      "required": ["systemId", "decommissionedAt"]
    }
  },
  "required": [
    "eventId",
    "eventType",
    "eventVersion",
    "occurredAt",
    "aggregateId",
    "aggregateVersion",
    "data"
  ]
}
```

## 3. インデックス・制約の定義

### 3.1 PostgreSQL インデックス設計

```sql
-- systems テーブルのインデックス
CREATE INDEX idx_systems_name ON systems(name); -- 一意制約により自動作成されるが明示
CREATE INDEX idx_systems_type ON systems(type);
CREATE INDEX idx_systems_status ON systems(status);
CREATE INDEX idx_systems_security_classification ON systems(security_classification);
CREATE INDEX idx_systems_criticality_level ON systems(criticality_level);
CREATE INDEX idx_systems_created_date ON systems(created_date);
CREATE INDEX idx_systems_last_modified ON systems(last_modified);
CREATE INDEX idx_systems_decommission_date ON systems(decommission_date) WHERE decommission_date IS NOT NULL;

-- 複合インデックス (よく使われるクエリパターン用)
CREATE INDEX idx_systems_type_status ON systems(type, status);
CREATE INDEX idx_systems_security_criticality ON systems(security_classification, criticality_level);
CREATE INDEX idx_systems_active_systems ON systems(status, last_modified) WHERE status IN ('ACTIVE', 'MAINTENANCE');

-- system_packages テーブルのインデックス
CREATE INDEX idx_system_packages_system_id ON system_packages(system_id);
CREATE INDEX idx_system_packages_name_type ON system_packages(package_name, package_type);
CREATE INDEX idx_system_packages_security_compliance ON system_packages(is_security_compliant) WHERE is_security_compliant = false;
CREATE INDEX idx_system_packages_install_date ON system_packages(install_date);

-- system_name_reservations テーブルのインデックス
CREATE INDEX idx_system_name_reservations_expires_at ON system_name_reservations(expires_at);

-- 部分インデックス (パフォーマンス最適化)
CREATE INDEX idx_systems_active_high_criticality ON systems(system_id, name)
WHERE status = 'ACTIVE' AND criticality_level IN ('HIGH', 'CRITICAL');
```

### 3.2 制約とトリガー

```sql
-- 更新日時の自動更新トリガー
CREATE OR REPLACE FUNCTION update_last_modified_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.last_modified = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_systems_last_modified
    BEFORE UPDATE ON systems
    FOR EACH ROW EXECUTE FUNCTION update_last_modified_column();

CREATE TRIGGER update_system_packages_last_updated
    BEFORE UPDATE ON system_packages
    FOR EACH ROW EXECUTE FUNCTION update_last_modified_column();

-- 期限切れ予約の自動削除関数
CREATE OR REPLACE FUNCTION cleanup_expired_reservations()
RETURNS void AS $$
BEGIN
    DELETE FROM system_name_reservations
    WHERE expires_at < CURRENT_TIMESTAMP;
END;
$$ LANGUAGE plpgsql;

-- 定期実行用のスケジュール (PostgreSQL拡張またはcron jobで実行)
-- SELECT cron.schedule('cleanup-reservations', '*/5 * * * *', 'SELECT cleanup_expired_reservations();');
```

### 3.3 EventStore DB プロジェクション設定

```javascript
// System Name Uniqueness Projection
fromStream('$ce-system')
    .when({
        'SystemRegistered': function(state, event) {
            const systemName = event.data.name.toLowerCase();

            if (state.registeredNames && state.registeredNames[systemName]) {
                throw new Error(`System name '${event.data.name}' already exists`);
            }

            if (!state.registeredNames) {
                state.registeredNames = {};
            }

            state.registeredNames[systemName] = {
                systemId: event.data.systemId,
                registeredAt: event.data.registeredAt
            };

            return state;
        },
        'SystemDecommissioned': function(state, event) {
            const systemName = event.data.name?.toLowerCase();
            if (state.registeredNames && systemName && state.registeredNames[systemName]) {
                delete state.registeredNames[systemName];
            }
            return state;
        }
    })
    .outputState();

// Active Systems by Type Projection
fromStream('$ce-system')
    .when({
        'SystemRegistered': function(state, event) {
            if (!state.systemsByType) {
                state.systemsByType = {};
            }

            const type = event.data.type;
            if (!state.systemsByType[type]) {
                state.systemsByType[type] = [];
            }

            state.systemsByType[type].push({
                systemId: event.data.systemId,
                name: event.data.name,
                status: 'ACTIVE', // 初期状態
                criticality: event.data.criticalityLevel,
                packageCount: event.data.initialPackages.length
            });

            return state;
        },
        'SystemDecommissioned': function(state, event) {
            if (state.systemsByType) {
                Object.keys(state.systemsByType).forEach(type => {
                    state.systemsByType[type] = state.systemsByType[type].filter(
                        system => system.systemId !== event.aggregateId
                    );
                });
            }
            return state;
        }
    })
    .outputState();
```

## 4. データマイグレーション設計

### 4.1 マイグレーション戦略

#### Phase 1: スキーマ作成 (V1.0.0)

```sql
-- migrations/V1.0.0__create_system_tables.sql

-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- Create system_types table first (referenced by systems)
CREATE TABLE system_types (
    -- テーブル定義 (上記参照)
);

-- Insert initial data
INSERT INTO system_types VALUES (
    -- 初期データ (上記参照)
);

-- Create systems table
CREATE TABLE systems (
    -- テーブル定義 (上記参照)
);

-- Create system_packages table
CREATE TABLE system_packages (
    -- テーブル定義 (上記参照)
);

-- Create system_name_reservations table
CREATE TABLE system_name_reservations (
    -- テーブル定義 (上記参照)
);

-- Create indexes
-- インデックス作成 (上記参照)

-- Create triggers and functions
-- トリガー・関数作成 (上記参照)

-- Create views
CREATE VIEW system_summary_view AS (
    -- ビュー定義 (上記参照)
);
```

#### Phase 2: 初期データ投入 (V1.0.1)

```sql
-- migrations/V1.0.1__insert_sample_data.sql

-- サンプルシステムデータ (開発・テスト用)
INSERT INTO systems (
    system_id, name, type, status,
    host_cpu_cores, host_memory_gb, host_storage_gb,
    host_encryption_enabled, security_classification, criticality_level,
    created_by
) VALUES
(
    gen_random_uuid(), 'web-frontend-prod', 'WEB', 'ACTIVE',
    4, 8, 100, true, 'INTERNAL', 'HIGH',
    'system-admin'
),
(
    gen_random_uuid(), 'api-gateway-prod', 'API', 'ACTIVE',
    8, 16, 200, true, 'CONFIDENTIAL', 'CRITICAL',
    'system-admin'
),
(
    gen_random_uuid(), 'database-primary', 'DATABASE', 'ACTIVE',
    16, 64, 1000, true, 'RESTRICTED', 'CRITICAL',
    'system-admin'
);
```

#### Phase 3: パフォーマンス最適化 (V1.1.0)

```sql
-- migrations/V1.1.0__performance_optimization.sql

-- パーティショニング (将来的なデータ増加対応)
-- 年月でパーティショニング
CREATE TABLE system_packages_y2025m09 PARTITION OF system_packages
    FOR VALUES FROM ('2025-09-01') TO ('2025-10-01');

-- 統計情報の更新
ANALYZE systems;
ANALYZE system_packages;
ANALYZE system_types;

-- 追加インデックス (運用データ分析後)
CREATE INDEX CONCURRENTLY idx_systems_vulnerability_scan
    ON systems(system_id, last_modified)
    WHERE status = 'ACTIVE';
```

### 4.2 データ整合性チェック

```sql
-- データ整合性チェッククエリ集

-- 1. システムテーブルの基本整合性
SELECT
    'systems基本チェック' as check_name,
    COUNT(*) as total_records,
    COUNT(CASE WHEN name IS NULL OR name = '' THEN 1 END) as invalid_names,
    COUNT(CASE WHEN type NOT IN ('WEB', 'API', 'DATABASE', 'BATCH', 'OTHER') THEN 1 END) as invalid_types,
    COUNT(CASE WHEN status NOT IN ('PLANNING', 'ACTIVE', 'MAINTENANCE', 'DECOMMISSIONED', 'CANCELLED') THEN 1 END) as invalid_status
FROM systems;

-- 2. ホスト構成の妥当性チェック
SELECT
    'ホスト構成チェック' as check_name,
    COUNT(CASE WHEN host_cpu_cores < 1 THEN 1 END) as invalid_cpu,
    COUNT(CASE WHEN host_memory_gb < 1 THEN 1 END) as invalid_memory,
    COUNT(CASE WHEN host_storage_gb < 1 THEN 1 END) as invalid_storage
FROM systems;

-- 3. セキュリティ分類の整合性チェック
SELECT
    'セキュリティ整合性チェック' as check_name,
    COUNT(*) as high_security_systems,
    COUNT(CASE WHEN host_encryption_enabled = false THEN 1 END) as unencrypted_systems
FROM systems
WHERE security_classification IN ('CONFIDENTIAL', 'RESTRICTED');

-- 4. パッケージ参照整合性チェック
SELECT
    'パッケージ参照整合性' as check_name,
    COUNT(sp.*) as total_packages,
    COUNT(s.system_id) as valid_references
FROM system_packages sp
LEFT JOIN systems s ON sp.system_id = s.system_id;

-- 5. 期限切れ予約チェック
SELECT
    '期限切れ予約' as check_name,
    COUNT(*) as expired_reservations
FROM system_name_reservations
WHERE expires_at < CURRENT_TIMESTAMP;
```

### 4.3 ロールバック手順

```sql
-- ロールバック用スクリプト (緊急時)

-- Step 1: 外部キー制約を無効化
ALTER TABLE system_packages DISABLE TRIGGER ALL;

-- Step 2: データバックアップ
CREATE TABLE systems_backup_$(date +%Y%m%d) AS SELECT * FROM systems;
CREATE TABLE system_packages_backup_$(date +%Y%m%d) AS SELECT * FROM system_packages;

-- Step 3: テーブル削除 (必要に応じて)
DROP VIEW IF EXISTS system_summary_view;
DROP TABLE IF EXISTS system_packages;
DROP TABLE IF EXISTS systems;
DROP TABLE IF EXISTS system_name_reservations;
DROP TABLE IF EXISTS system_types;

-- Step 4: 関数・トリガー削除
DROP FUNCTION IF EXISTS update_last_modified_column();
DROP FUNCTION IF EXISTS cleanup_expired_reservations();
```

### 4.4 運用メンテナンス

```sql
-- 日次メンテナンス用クエリ

-- 1. 期限切れ予約の削除
DELETE FROM system_name_reservations WHERE expires_at < CURRENT_TIMESTAMP;

-- 2. 統計情報の更新
ANALYZE systems;
ANALYZE system_packages;

-- 3. インデックスの再構築 (週次)
REINDEX INDEX CONCURRENTLY idx_systems_name;
REINDEX INDEX CONCURRENTLY idx_system_packages_system_id;

-- 4. バキューム処理 (週次)
VACUUM ANALYZE systems;
VACUUM ANALYZE system_packages;

-- 5. ディスク使用量チェック
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

## 5. 受け入れ条件確認

- ✅ **systems テーブルのスキーマ定義**: 完了
- ✅ **system_types テーブルのスキーマ定義**: 完了
- ✅ **EventStore イベントスキーマ定義**: 完了
- ✅ **インデックス・制約の実装**: 完了

## 6. 実装優先度

### Phase 1: 基本スキーマ (Sprint 1)
1. PostgreSQL テーブル作成
2. 基本インデックス設定
3. 初期データ投入

### Phase 2: EventStore 統合 (Sprint 2)
1. イベントスキーマ実装
2. プロジェクション設定
3. イベント→ReadModel更新処理

### Phase 3: 運用最適化 (Sprint 3)
1. パフォーマンス最適化
2. データマイグレーション手順
3. 監視・メンテナンス体制

---

**文書管理**:
- **作成者**: データベースアーキテクト
- **レビュー要求**: ソフトウェアアーキテクト、バックエンドエンジニア
- **次期作業**: NestJS実装 (Repository層、EventStore統合)