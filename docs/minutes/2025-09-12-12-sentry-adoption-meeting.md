# System Board - Sentry導入検討会議 議事録

## 会議概要

**日時**: 2025-09-12 12:15-13:15
**議題**: 運用監視にSentry導入の技術的検討  
**参加者**: ソフトウェアアーキテクト、DevOpsエンジニア、バックエンドシステムアーキテクト、サイバーセキュリティアドバイザー  
**目的**: Sentryの導入により置き換えられる技術スタックの確認と影響評価

## 背景

運用監視でSentryを採用することで、フルマネージドサービスによる運用負荷の軽減が期待されるため、技術スタック変更の詳細検討を実施。

## 現在の監視スタック

- **Prometheus + Grafana**: メトリクス監視
- **ELK Stack**: ログ管理
- **Microsoft Teams**: アラート・エスカレーション

## 各エージェントからの分析結果

### 1. ソフトウェアアーキテクト分析

#### Sentryとアーキテクチャの適合性

- **統合位置**: アプリケーション層（Hexagonal Architecture内）
- **適用範囲**: React UI + NestJSコントローラー、アプリケーションサービス、インフラストラクチャ層

#### 技術スタック置き換え状況

- **部分置き換え**: ELK Stackのエラーログ部分
- **補完的統合**: Prometheus/Grafana（インフラメトリクス）、Microsoft Teams（アラート）と併用

#### 推奨アーキテクチャ（ハイブリッド構成）

```text
アプリケーション層:
- Sentry: エラートラッキング、パフォーマンス監視、ユーザーコンテキスト
- ELK Stack: 監査ログ、ビジネスログ、デバッグログ

インフラストラクチャ層:
- Prometheus: システムメトリクス、アプリメトリクス
- Grafana: ダッシュボード、可視化

通知統合:
- Microsoft Teams: Sentry Webhooks + Prometheus AlertManager
```

### 2. DevOpsエンジニア分析

#### 運用効率への影響

- **運用負荷削減**: 50-70%のメンテナンス工数削減見込み
- **開発者体験**: コンテキスト付きデバッグによる改善

#### コスト分析

- **無料枠**: 5,000エラー/月、10,000パフォーマンス単位/月
- **プロジェクト規模**: 5-10同時利用者では無料枠内で対応可能

#### 実装優先順位

1. **高**: NestJSバックエンドのエラートラッキング・パフォーマンス監視
2. **中**: Reactフロントエンドエラートラッキング
3. **低**: カスタムビジネスメトリクス

### 3. バックエンドシステムアーキテクト分析

#### NestJS統合実装

```typescript
// グローバル例外フィルター
@Catch()
export class SentryExceptionFilter implements ExceptionFilter {
  catch(exception: unknown, host: ArgumentsHost) {
    Sentry.captureException(exception);
  }
}

// データベース監視
@Injectable()
export class DatabaseRepository {
  async findVulnerabilities(): Promise<Vulnerability[]> {
    const transaction = Sentry.startTransaction({
      name: 'vulnerability-query',
      op: 'db.query'
    });
    
    try {
      return await this.repository.find();
    } finally {
      transaction.finish();
    }
  }
}
```

#### Event Sourcing対応

- **互換性**: イベントハンドラーでのパフォーマンストラッキング対応
- **監視対象**: 脆弱性処理、システム同期、外部API統合

#### セキュリティ実装

- **データ分類**: beforeSendフックによる機密データマスキング
- **製造業対応**: システム設定、脆弱性詳細、内部ホスト名の除外

### 4. サイバーセキュリティアドバイザー分析

#### リスク評価レベル: **MEDIUM-HIGH**

#### 重大なセキュリティ懸念事項

1. **第三者データ管理**: 全エラーデータがSentryインフラに保存
2. **国境越えデータ転送**: データローカライゼーション要件違反リスク
3. **製造業機密情報漏洩**: 生産パラメータ、プロセスデータの露出リスク

#### 製造業特有のリスク

- **生産システム露出**: エラーメッセージ内の機密製造パラメータ
- **システムトポロジー開示**: スタックトレースによる内部アーキテクチャ詳細
- **事業プロセス露出**: パフォーマンスデータから生産スケジュール推定

#### コンプライアンス要件との衝突

- **ISO 27001**: 情報セキュリティ管理要件
- **NIST Cybersecurity Framework**: データ保護・プライバシー統制
- **Industry 4.0 Security**: 製造業特化サイバーセキュリティ標準

## 技術的推奨事項

### アーキテクト・DevOps推奨: **ハイブリッド導入**

- **導入範囲**: アプリケーション監視のみ
- **維持範囲**: インフラメトリクス（Prometheus/Grafana）、コンプライアンス監査（ELK Stack）
- **実装フェーズ**:
  1. 基本エラートラッキング（データサニタイゼーション付き）
  2. パフォーマンス監視統合
  3. Microsoft Teamsカスタムアラート
  4. Event Sourcing操作の高度トレーシング

## セキュリティ勧告

### **最終推奨: Sentryマネージドサービス採用を見送り**

#### 理由

1. **情報漏洩防止優先方針との直接的な衝突**
2. **製造業環境でのコンプライアンスリスクが高すぎる**
3. **現在のスタック（ELK + Prometheus）が要件を満たしている**
4. **セキュリティリスクが運用効率のメリットを上回る**

### 代替案推奨

#### 強化された自己ホスティング解決策

```yaml
monitoring_stack:
  error_tracking:
    - GlitchTip (オープンソースSentry代替)
    - ELK Stackによるカスタムエラー集約の強化
  
  performance_monitoring:
    - Jaeger (分散トレーシング)
    - OpenTelemetry (ベンダー中立な可観測性)
    - Grafanaダッシュボード拡張
  
  alerting:
    - AlertManager (Prometheusエコシステム)
    - Microsoft Teams統合（既定通り）
```

## 決定事項

### **技術スタック変更: 見送り**

現在の監視スタックを維持し、以下の改善を実施：

1. **ELK Stack強化**: エラー集約とアラート機能の改善
2. **構造化ログ実装**: より良い分析のための標準エラー形式
3. **カスタムダッシュボード開発**: Grafanaでの製造業特化KPI
4. **監視SLA確立**: 応答時間とエスカレーション手順の定義

### 今後の検討事項

- Sentryのオンプレミス/プライベートクラウドオファリングの監視
- GlitchTipなどのオープンソース代替案の評価
- 監視インフラストラクチャ専門知識への投資

## アクションアイテム

| 項目 | 担当 | 期限 |
|------|------|------|
| ELK Stackエラー集約機能強化 | DevOpsエンジニア | 2週間以内 |
| 製造業特化Grafanaダッシュボード作成 | DevOpsエンジニア | 3週間以内 |
| 構造化ログ標準化 | バックエンドエンジニア | 2週間以内 |
| 監視SLA文書化 | アーキテクト | 1週間以内 |
| 四半期セキュリティレビュー計画策定 | セキュリティエンジニア | 1週間以内 |

---

**結論**: 製造業環境のセキュリティ要件と情報漏洩防止の優先方針により、Sentryマネージドサービスの導入は適切でないと判断。現在の自己ホスティング手法を改善することで、セキュリティ要件を満たしながら監視機能を強化する。
